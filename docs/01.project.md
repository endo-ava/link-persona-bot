# 要件定義書

## 1. アプリケーション概要 (What)

Discord に投稿された URL リンク先の記事を AI が読み解き、**独自の「人格」を持って自己紹介風に要約する Discord Bot**。
単なる情報提供に留まらず、人格のカスタマイズ、記事とのディベートなど、「遊び心」を加速させる機能群を搭載し、記事の擬人化を通じた新しい情報体験を提供する。

## 2. 背景と目的

### 2.1 背景 (Background)

- 純粋な「**遊び心**」と「チャットボット開発への興味」を起点とする。
- まずは開発者と**仲間内で使って楽しめる**ユニークなツールを作ることを動機とする。

### 2.2 目的 (Purpose)

- **擬人化体験の提供:** 記事（情報）そのものに「人格」を付与することで、「この記事、なんか喋ってる」というエンターテイメント体験を創出する。
- **コミュニケーションの活性化:** Bot のユニークな要約や拡張機能を通じて、共有された URL を起点としたサーバー内での会話やリアクションを誘発する。
- **拡張性の担保:** 新しい「人格」や「遊び」を容易に追加できる設計を採用し、コミュニティが飽きずに使い続けられるプラットフォームを提供する。

## 3. コアコンセプト / 設計思想

- **情報が「人格」になる:** 無機質な情報をキャラクター化することで、情報への親近感と記憶定着率を高める。
- **「遊び」の誘発:** ユーザーが思わず試したくなるようなコマンド（`/debate`）を設計し、Bot を「ツール」ではなく「遊び相手」として機能させる。
- **Discord 文化への最適化:** ロボット感を排し、サーバーの「一員」として振る舞うようなインタラクションを設計する。
- **高い拡張性:** 人格テンプレート（YAML）の追加・編集を容易にし、運用しながら Bot を成長させられる構造にする。

## 4. 想定ユーザー (Who)

本アプリケーションは、以下のユーザーをターゲットとして設計する。

- **フェーズ 1（初期）:** 開発者の**知り合い、およびクローズドな小規模 Discord サーバー**。
- **フェーズ 2（将来）:** 機能と安定性を向上させた上で、**一般公開**し、不特定多数のサーバーへの導入を目指す。

## 4. 使用技術

本アプリケーション開発に使用する主要な技術スタック、および開発・インフラ環境は以下の通りである。

### 4.1 主要技術スタック

アプリケーションを直接構成するフレームワーク、ライブラリ。

| 技術                          | カテゴリ           | バージョン | 用途                                                         |
| :---------------------------- | :----------------- | :--------- | :----------------------------------------------------------- |
| `discord.py` (or `nextcord`)  | Discord Bot        | 最新安定版 | Discord API との連携、イベント監視、コマンド応答             |
| `FastAPI`                     | API サーバー       | 最新安定版 | Discord Bot からの HTTP リクエストを受け付けるエンドポイント |
| `trafilatura`                 | Web スクレイピング | 最新安定版 | URL から記事本文をクリーンなテキストとして抽出               |
| `Qwen API`                    | LLM API            | -          | 記事の要約、トーン分析、人格付与、各種生成タスク             |
| `Qdrant Lite` (or `FAISS`)    | ベクトル DB        | 最新安定版 | ユーザーの過去リンク履歴（F06）のインメモリ RAG              |
| `In-memory dict` (or `Redis`) | キャッシュ         | -          | 同一 URL のフェッチ結果を一時的にキャッシュ                  |

### 4.2 開発・インフラ環境

開発効率の向上、コード品質の担保、およびデプロイメントに使用するツール・サービス。

| 技術            | カテゴリ         | 用途                                   |
| :-------------- | :--------------- | :------------------------------------- |
| `Koyeb`         | ホスティング     | API サーバーのデプロイ、無料枠での運用 |
| `Docker`        | コンテナ         | Koyeb へのデプロイ環境のコンテナ化     |
| `GitHub` (想定) | ソースコード管理 | CI/CD 連携（Koyeb への自動デプロイ）   |
| `YAML`          | 設定ファイル     | 人格テンプレートの管理                 |

## 5. 機能要件

本アプリケーションの機能要件を以下に定義する。

### 5.1 機能カテゴリ

要件 ID の百の位は、以下の機能カテゴリを示す。

- **100 番台:** コア要約機能（URL の検知、要約、人格付与）
- **200 番台:** ユーザー操作機能（スラッシュコマンド）
- **300 番台:** コンテキスト機能（ユーザー履歴の記憶）

### 5.2 機能要件一覧

優先度は MoSCoW 分析（Must, Should, Could, Won't）に基づき評価する。

| 要件 ID  | カテゴリ     | 機能概要                   | 詳細                                                                                                                                                                                                                                                                                                                                           | 優先度     |
| :------- | :----------- | :------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :--------- |
| **F101** | コア要約     | **Auto Persona Summarize** | ユーザーが投稿したメッセージを監視し、URL が含まれていた場合、自動でスレッドを作成（あるいはリプライ）する。URL 先の本文を抽出し、LLM（Qwen）が分析・要約。**デフォルト人格**（または F201 で指定された人格）で自己紹介風に Embed 投稿する。                                                                                                   | **Must**   |
| **F201** | ユーザー操作 | **Persona Chat Mode**      | `/persona <style>` コマンド（例: `/persona sarcastic`）を実行すると、Bot はそのチャンネル（またはスレッド）で、指定された人格（ペルソナ）に切り替わる。<br>**このモード中、Bot は URL がなくとも通常のチャットに応答する**ようになり、指定された人格として会話を継続する。<br>（人格を解除するコマンド `/persona reset` なども必要かを要検討） | **Must**   |
| **F202** | ユーザー操作 | **Debate Mode**            | `/debate <URL or 直前のBot投稿>` コマンドにより、記事の主張に対する「反論 AI」を生成し、簡易的なディベート（両者の主張のまとめ）を投稿する。                                                                                                                                                                                                   | **Should** |
| **F301** | コンテキスト | **Context Memory (RAG)**   | 同一ユーザーの過去のリンク投稿履歴（記事の概要やトピック）を軽量 RAG で記憶する。F101 の要約時、記憶した過去の嗜好性に基づき、「（こういうの好きですよね？）」などの補足コメントを追記する。                                                                                                                                                   | **Could**  |
| **F302** | コンテキスト | **Chat Memory (F201)**     | F201 の会話モード中、直前の会話履歴を短期記憶として LLM に渡し、文脈を維持した会話（例: 「さっきの話だけど」）を可能にする。                                                                                                                                                                                                                   | **Must**   |

---

**補足：将来的な機能拡張案**

MVP（最小実行可能製品）のスコープ外とするが、将来的には以下のような「遊び心」をさらに加速させる機能の実装を検討する。

- `/age` : 記事が何歳くらいの人によって書かれたかを AI が推定する機能。
- `/dream` : 「この記事が見た夢」を AI が創造して語る機能。

## 6. 非機能要件

アプリケーションの品質を保証するため、以下の非機能要件を定義する。

| カテゴリ           | 要件             | 目標・指標                                                                                                                                                                            |
| :----------------- | :--------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **パフォーマンス** | 応答時間         | URL 投稿後、Bot が要約を投稿するまで、**ユーザーが一般的に「遅い」と感じない程度**（体感 10 秒前後）の応答速度を目指す。                                                              |
| **パフォーマンス** | 本文抽出         | JavaScript レンダリングが必要なサイト（SPA）は対象外とし、`trafilatura`で抽出可能な静的 HTML サイトのみをサポート対象とする。抽出失敗時は人格に応じたエラーメッセージを返す。         |
| **可用性**         | F                | ホスティング先（Koyeb）の SLA に準拠する。無料枠のスリープからの復帰時間を許容する。                                                                                                  |
| **セキュリティ**   | 認証情報管理     | Qwen API キーや Discord Bot トークンは、Koyeb の Secrets 機能を用いて環境変数として管理し、コードベースにハードコードしない。                                                         |
| **セキュリティ**   | スパム対策       | 同一ユーザーによるコマンドリクエストは 1 分間に 1 回まで（レートリミット）とする。                                                                                                    |
| **セキュリティ**   | 対象 URL 制限    | Bot がフェッチする URL は、一般的な Web ドメイン（`.com`, `.jp`など）に限定し、不審なドメインや IP アドレス直打ちをブロックする。（ホワイトリストまたはブラックリスト方式）           |
| **コスト**         | API コスト制御   | LLM（Qwen）に渡す記事本文は、コストとコンテキスト長を考慮し、最大 2000 文字（あるいはそれに相当するトークン数）で切り詰める（Truncate）。                                             |
| **保守性・拡張性** | 人格テンプレート | 新しい人格の追加・修正が、`personas/`ディレクトリへの YAML ファイルの追加・編集のみで完了するように設計する。API サーバーの再起動は不要（あるいは自動リロード）であることが望ましい。 |
| **保守性**         | RAG データ       | F301 のベクトルデータは、Koyeb の仕様（エフェメラルファイルシステム）に基づき、永続化されない（デプロイや再起動で失われる）ことを許容する。                                           |
