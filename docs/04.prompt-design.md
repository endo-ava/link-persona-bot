# プロンプト設計ガイドライン

Link Persona Bot におけるプロンプト設計の原則を説明します。

## 設計原則

### 単一責任の原則（SRP: Single Responsibility Principle）

プロンプト設計を**3つの層**に分離し、それぞれが明確な責務を持ちます。

```
┌─────────────────────────────────────────────────┐
│ 1. YAML Persona (api/personas/*.yaml)          │
│    責務: ペルソナの「人格・口調・トーン」      │
│    例: 「温かく内省的な語り口で」              │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ 2. Config (api/config.py)                      │
│    責務: 技術的制約・システム設定              │
│    例: summary_max_length = 300                │
└─────────────────────────────────────────────────┘
                      ↓
┌─────────────────────────────────────────────────┐
│ 3. Service Layer (api/services/*.py)           │
│    責務: タスク指示・ビジネスロジック          │
│    例: 「要約して」「完結した文章で」          │
└─────────────────────────────────────────────────┘
```

### 唯一の真実の源（Single Source of Truth）

- 技術的制約（文字数、タイムアウト）→ **Config**のみ
- ペルソナの人格設定 → **YAML**のみ
- タスク指示 → **Service**のみ

重複・競合を避け、変更時の影響範囲を最小化します。

---

## 各層の責務

### 1. YAML Persona（ペルソナ定義）

**ファイル:** `api/personas/*.yaml`

**✅ 含めるべきもの:**
- キャラクター設定（年齢、性別、職業、性格）
- 語り口・トーン（「温かく」「皮肉を込めて」）
- 専門用語・口癖
- 応答スタイル
- **必須**: 「地の文は使わず、直接語りかける形で」

**❌ 含めてはいけないもの:**
- 文字数指定（例: 「100-200字で」）
- タスク指示（例: 「要約して」）
- 技術的制約（例: タイムアウト）

**テンプレート:**
```yaml
name: "ペルソナ名"
icon: "😊"
color: 0x3498db
description: "短い説明"

system_prompt: |
  あなたは「ペルソナ名」です。

  キャラクター設定:
  - 性別、年齢、職業、性格、特徴

  応答のルール:
  - （トーン・スタイル）
  - （専門用語の使い方）

examples:
  - input: "質問"
    output: "回答"
```

### 2. Config（技術的設定）

**ファイル:** `api/config.py`

**✅ 含めるべきもの:**
- 文字数制限（summary_min_length, summary_max_length）
- 記事本文の最大文字数
- APIタイムアウト
- その他の数値的制約

**❌ 含めてはいけないもの:**
- ペルソナの人格設定
- 具体的なタスク指示文

**例:**
```python
@property
def summary_min_length(self) -> int:
    return 200

@property
def summary_max_length(self) -> int:
    return 300
```

### 3. Service Layer（タスク指示）

**ファイル:** `api/services/article_service.py`, `api/services/debate_service.py`

**✅ 含めるべきもの:**
- タスクの具体的な指示
- 形式的な制約（「地の文禁止」「完結した文章」）
- Configからの設定値参照
- ペルソナのsystem_promptとの組み合わせ

**❌ 含めてはいけないもの:**
- ハードコードされた文字数
- ペルソナの人格設定

**プロンプト構築例:**
```python
# Configから値を読み込む
min_len = self.settings.summary_min_length
max_len = self.settings.summary_max_length

# タスク指示を構築
user_prompt = f"""以下の記事を{min_len}〜{max_len}字で要約してください。

"""

# ペルソナのsystem_promptと組み合わせて生成
await self.llm_client.generate_persona_response(
    system_prompt=persona.get_system_message(),  # YAMLから
    user_message=user_prompt,
)
```


## トラブルシューティング

| 問題 | 原因 | 解決方法 |
|------|------|---------|
| 文が途中で切れる | 文字数上限が小さい | Configの`summary_max_length`を増やす + プロンプトに「完結した文章で」追加 |
| 地の文が含まれる | YAMLに曖昧な指示 | YAMLに「地の文は使わず」追加 + プロンプトに明示的な禁止指示 |
| ペルソナの口調が弱い | ルールが曖昧、examples不足 | 応答ルールを具体化、examples追加（3-5個） |
| 設定が反映されない | サーバー未再起動 | APIサーバーとBotを再起動 |

---

### 参考資料

- [ペルソナYAML仕様](../api/personas/README.md) - YAMLファイルの詳細
- [システムアーキテクチャ](./02.architecture.md) - 全体アーキテクチャ
- [API層README](../api/README.md) - API層の詳細
