
## 🧠 1. 動作フロー例

1. ユーザーがDiscordにURLを投稿  
2. Discord Botがメッセージを監視 → URLを検出  
3. Koyebエンドポイント (`/ingest`) に `POST { url, user_id, guild_id }`  
4. Koyebサービス内で：
   - `trafilatura` で本文抽出
   - Qwen API に以下をリクエスト：
     ```text
     記事: {text}
     タスク:
     1. 100字以内の要約
     2. トーン分析（例: 懐疑的/熱狂的/ユーモラス）
     3. 想定著者像（年齢・職業・性格キーワード）
     ```
   - 人格テンプレートから最適なものを選択（例: トーン=皮肉 → `sarcastic`）
   - Qwenに再リクエスト：「以下の人格で要約を自己紹介風に語れ」
5. 結果をDiscordに埋め込みメッセージで投稿（アイコン・色・キャラ名付き）


## ⚙️ 2. 技術スタック & アーキテクチャ

### 全体構成図（簡易）

```
[Discord] 
   │
   ↓ (message with URL)
[Discord Bot (discord.py)] 
   │
   ↓ (HTTP POST)
[Koyeb Service: link-persona-api] 
   ├── Fetcher: trafilatura (HTML → clean text)
   ├── Analyzer: Qwen API (summarize + tone + persona)
   ├── Generator: Qwen API (narrate with persona)
   └── Optional: Qdrant Lite (in-memory RAG for user context)
   │
   ↓ (JSON response)
[Discord Bot] → Embed Message with personality flair
```

## 📁 3. ディレクトリ構成（MVP）

```bash
link-persona-bot/
├── bot/                     # Discord Bot
│   ├── main.py
│   └── commands.py
├── api/                     # Koyeb向けAPI
│   ├── main.py              # FastAPI
│   ├── fetcher.py           # trafilatura
│   ├── llm_client.py        # LLM APIクライアント（OpenAI互換）
│   └── personas/            # 人格テンプレート
│       ├── default.yaml
│       ├── sarcastic.yaml
│       ├── anime.yaml
│       └── professor.yaml
├── context/                 # 軽量RAG（ユーザー履歴）
│   └── memory.py            # FAISS or dict-based
├── Dockerfile               # Koyebデプロイ用
└── requirements.txt
```

---

## 🎭 4. 人格テンプレート例（YAML）

```yaml
# personas/sarcastic.yaml
name: "毒舌ジャーナリスト"
icon: "👁️"
color: 0xff4500
system_prompt: |
  あなたは皮肉たっぷりのベテランジャーナリストです。
  要約は100字以内で、必ず「…らしいですよ？」や「どうせ～」などの言い回しを使い、
  少し冷笑的に、でも核心を突いて話してください。
examples:
  - input: "AIが人間の仕事を奪う"
    output: "あら、またAIがお仕事泥棒してんの？どうせ人間が楽したいだけなんでしょうけど～"
```
